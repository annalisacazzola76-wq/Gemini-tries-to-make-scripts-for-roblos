-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LPlayer = Players.LocalPlayer
local GUI_NAME = "FE_FLY_GUI"

-- --- FUNZIONE PER L'EFFETTO ARCOBALENO ---
local function MakeRainbow(object)
    task.spawn(function()
        while object and object.Parent do
            local hue = tick() % 5 / 5
            local color = Color3.fromHSV(hue, 1, 1)
            if object:IsA("UIStroke") then
                object.Color = color
            elseif object:IsA("TextLabel") or object:IsA("TextButton") then
                object.TextColor3 = color
            end
            RunService.RenderStepped:Wait()
        end
    end)
end

-- --- FUNZIONE PER CREARE NOTIFICHE ---
local function ShowNotification(message)
    local NotifyGui = Instance.new("ScreenGui", game.CoreGui)
    local NotifyFrame = Instance.new("Frame", NotifyGui)
    local NotifyText = Instance.new("TextLabel", NotifyFrame)
    local NotifyStroke = Instance.new("UIStroke", NotifyFrame)
    local NotifyCorner = Instance.new("UICorner", NotifyFrame)

    NotifyFrame.Size = UDim2.new(0, 250, 0, 60)
    NotifyFrame.Position = UDim2.new(1, 20, 0.85, 0) -- Parte da fuori (destra)
    NotifyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NotifyFrame.BorderSizePixel = 0

    NotifyText.Size = UDim2.new(1, -20, 1, 0)
    NotifyText.Position = UDim2.new(0, 10, 0, 0)
    NotifyText.BackgroundTransparency = 1
    NotifyText.Text = message
    NotifyText.TextColor3 = Color3.fromRGB(255, 255, 255)
    NotifyText.Font = Enum.Font.GothamBold
    NotifyText.TextSize = 14
    NotifyText.TextWrapped = true

    NotifyStroke.Thickness = 2
    NotifyCorner.CornerRadius = UDim.new(0, 10)
    MakeRainbow(NotifyStroke)

    -- Animazione Entrata/Uscita
    NotifyFrame:TweenPosition(UDim2.new(1, -270, 0.85, 0), "Out", "Back", 0.5)
    task.delay(3, function()
        if NotifyFrame then
            NotifyFrame:TweenPosition(UDim2.new(1, 20, 0.85, 0), "In", "Linear", 0.5)
            task.wait(0.5)
            NotifyGui:Destroy()
        end
    end)
end

-- --- CONTROLLO DOPPIA ESECUZIONE ---
if game.CoreGui:FindFirstChild(GUI_NAME) then
    ShowNotification("Already executed!")
    return -- Ferma lo script qui
end

-- --- SE NON ESISTE, PROCEDI CON L'ESECUZIONE ---
ShowNotification("Thanks for executing, " .. LPlayer.Name .. "!")

-- Flight Variables
local flying = false
local flySpeed = 50
local bv, bg

-- --- CREAZIONE GUI PRINCIPALE ---
local MainGui = Instance.new("ScreenGui", game.CoreGui)
MainGui.Name = GUI_NAME

local MainFrame = Instance.new("Frame", MainGui)
local MainStroke = Instance.new("UIStroke", MainFrame)
local MainCorner = Instance.new("UICorner", MainFrame)
local Title = Instance.new("TextLabel", MainFrame)
local FlyBtn = Instance.new("TextButton", MainFrame)
local SpeedBox = Instance.new("TextBox", MainFrame)
local SpeedLabel = Instance.new("TextLabel", MainFrame)

MainFrame.Size = UDim2.new(0, 220, 0, 200)
MainFrame.Position = UDim2.new(0.5, -110, 0.5, -100)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true

MainStroke.Thickness = 3
MakeRainbow(MainStroke)
MainCorner.CornerRadius = UDim.new(0, 15)

Title.Size = UDim2.new(1, 0, 0, 45)
Title.BackgroundTransparency = 1
Title.Text = "FE FLY"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22

FlyBtn.Name = "FlyBtn"
FlyBtn.Parent = MainFrame
FlyBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
FlyBtn.Size = UDim2.new(0.8, 0, 0, 45)
FlyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
FlyBtn.Text = "Fly: OFF"
FlyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
FlyBtn.Font = Enum.Font.GothamBold
FlyBtn.TextSize = 18
Instance.new("UICorner", FlyBtn).CornerRadius = UDim.new(0, 10)

SpeedLabel.Size = UDim2.new(1, 0, 0, 20)
SpeedLabel.Position = UDim2.new(0, 0, 0.58, 0)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "Set Speed Below:"
SpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 12

SpeedBox.Name = "SpeedBox"
SpeedBox.Parent = MainFrame
SpeedBox.Position = UDim2.new(0.1, 0, 0.72, 0)
SpeedBox.Size = UDim2.new(0.8, 0, 0, 35)
SpeedBox.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
SpeedBox.Text = "50"
SpeedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedBox.Font = Enum.Font.Gotham
SpeedBox.TextSize = 16
Instance.new("UICorner", SpeedBox).CornerRadius = UDim.new(0, 8)

-- --- TRASCINAMENTO (DRAGGABLE) ---
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- --- LOGICA VOLO ---
FlyBtn.MouseButton1Click:Connect(function()
    flying = not flying
    flySpeed = tonumber(SpeedBox.Text) or 50
    
    if flying then
        FlyBtn.Text = "Fly: ON"
        FlyBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 80)
        
        local root = LPlayer.Character and LPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not root then return end
        
        bv = Instance.new("BodyVelocity", root)
        bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bv.Velocity = Vector3.new(0,0,0)
        
        bg = Instance.new("BodyGyro", root)
        bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bg.P = 9e4
        bg.CFrame = root.CFrame
        
        task.spawn(function()
            while flying do
                bv.Velocity = workspace.CurrentCamera.CFrame.LookVector * flySpeed
                bg.CFrame = workspace.CurrentCamera.CFrame
                RunService.RenderStepped:Wait()
            end
            if bv then bv:Destroy() end
            if bg then bg:Destroy() end
        end)
    else
        FlyBtn.Text = "Fly: OFF"
        FlyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    end
end)
